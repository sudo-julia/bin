#!/usr/bin/env bash
set -eo pipefail

# update system on arch, calls aur sep w extra util for aux programs (date-based) at end
# requires informant, pacman-contrib and yay


# TODO switch reads to -rp
# TODO check for installed programs before extraUpdates
# TODO Add updater for cargo and check for failures
#      this can be `if [ cmd ]; then \nprintf --'cmd updated\n'`
#### CARGO UPDATER PSEUDOCODE
# if "~/.cargo" exists; then
#     for dir that is not in {'bin', 'git', 'registry'}:
#         (cd "${DIR}" && cargo update)
# else
#     :

PACDIFF_RUN=0
USER_HOME=$( getent passwd "$SUDO_USER" | cut -d':' -f6 )

pacUpdate() {
	# run the main update
	informant check
	printf -- ':: Begin main update? [Y/n] '; read -r response
	case "$response" in
		y|Y)
			pacman -Syu
			pacdiff -o > /tmp/pacnew.out
			if [[ ! "${user}" ]]; then
				exit 0
			else
				printf -- ':: Also update AUR packages? [Y/n] '; read -r response
				case "$response" in
					y|Y)
						sudo -u "${user}" yay -Syua  ;;
					*)
						printf -- '%s\n' "Skipping AUR packages"
				esac
			fi  ;;
		*)
			printf -- '%s\n' "Cancelling update."
			exit 0
	esac
}


extraUpdates () {
	# update extra programs and non-arch package managers
	# if you don't want to use any of these, simply delete or comment-out the line
	if [[ ! "${user}" ]]; then
		return
	fi
    sudo -u "${user}" zsh "${USER_HOME}"/bin/runZinit.zsh
    sudo -u "${user}" /usr/bin/tldr --update > /dev/null && \
	printf -- 'Tldr cache updated.\n'
	sudo -u "${user}" vim +PluginInstall +qall
	printf -- 'Vim plugins updated.\n'
	sudo -u "${user}" "${USER_HOME}"/bin/upgradePip.bash
	removeOrphans
	printf -- '%s\n' "Checking pacman cache for old packages..."
	paccache -d
	printf -- ':: Clear pacman cache? [Y/n] '; read -r response
	case "$response" in
		y|Y)
			paccache -rv
			printf -- '%s\n' "Pacman cache cleared."  ;;
		*)
			printf -- '%s\n' "Skipping pacman cache."
		esac
    "${USER_HOME}"/bin/getInstalled.bash
	if [[ "$#" ]]; then
		echo "${1}" >> "${USER_HOME}"/bin/.lastDate
		printf -- '\nNext full update will run on or after %d.\n' "${2}"
	fi
}


checkLastDate() {
	# check if it's time to run extraUpdates
	if [[ ! "${pathToLastDate}" ]]; then
		# if the user doesn't want to make lastDate file
		printf 'Update other programs? '; read -r response
		case "${response}" in
			y|Y)
				extraUpdates  ;;
			*)
				printf -- '%s\n' "Skipping extra updates."
		esac
	elif [[ "${pathToLastDate}" ]] && [[ ! -s "${pathToLastDate}" ]]; then
		# if variable is set but file doesn't exist, create it
		echo '000000' > "${pathToLastDate}"
	elif [[ -s "${pathToLastDate}" ]]; then
		# check date to see if it's been a week since the last update
		lastDate=$( tail -n1 "${pathToLastDate}" )
		currentDate=$( date "+%Y%m%d" )
		currentDateLast=$( echo "${currentDate}" | cut -c7- )
		if (( currentDateLast >= 26 )); then
			nextDate=$( checkMonth )
		else
			nextDate=$(( lastDate + 7 ))
		fi
		if [[ "${currentDate}" -ge "${nextDate}" ]]; then
			extraUpdates "${currentDate}" "${nextDate}"
		fi
	fi
}


checkMonth () {
	# check the month and fix any incorrectly formatted dates
	currentMonth=$( echo "${currentDate}" | cut -c5-6 )
	newYear=$( echo "${currentDate}" | cut -c1-4 )
	newMonth="$(( currentMonth + 1 ))"
	if (( newMonth > 12 )); then
		newMonth=1
		newYear=$(( newYear + 1 ))
	fi
	days_thirtyone=(01 03 05 07 08 10 12)
	if [[ "${currentMonth}" =~ ${days_thirtyone[*]} ]]; then
		difference="$(( 7 - (31 - currentDateLast) ))"
	else
		difference="$(( 7 - (30 - currentDateLast) ))"
	fi
	if [[ "${#difference}" -eq 1 ]]; then
		difference="0${difference}"
	fi
	newDate="${newYear}${newMonth}${difference}"
	echo "${newDate}"
}


checkRoot() {
	# exit program if not run as root
	if [[ "$( id -u )" -ne 0 ]]; then
		printf -- '%s\n%s\n' "Error! Run as root." "Cancelling."
		exit 1
	fi
}


printPacdiff () {
	# print out any pacnew files
	if [[ "${PACDIFF_RUN}" -eq 0 ]] && [[ -s /tmp/pacnew.out ]]; then
		printf -- '\n%s\n%s\n' "Pacnew files:" "$( cat /tmp/pacnew.out )"
		PACDIFF_RUN=1
	fi
}


removeOrphans () {
	# remove orphaned pacman packages
	if pacman -Qdtq >/dev/null; then
		printf -- '%s\n' "Orphaned packages are:"
		pacman -Qdt
		printf -- '%s' "Remove orphan packages? [Y/n] "; read -r response
		case "$response" in
			y|Y)
				pacman -R --noconfirm "$(pacman -Qdtq)"  ;;
			*)
				printf -- '%s\n' "Leaving orphaned packages."
		esac
	else
		printf -- '%s\n' "No orphaned packages."
	fi
}


if getent passwd "jam" > /dev/null; then
	user=jam
	pathToLastDate="${USER_HOME}"/bin/.lastDate
else
	# if this is unset, the program will ask if you'd like to update extras every time it's run
	# change the user you're updating for here
	user=
	# if you want extra updates to run automatically, place the file to read them from here
	pathToLastDate=
fi

checkRoot
pacUpdate
checkLastDate
printPacdiff

exit 0
