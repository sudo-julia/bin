#!/usr/bin/env python3
"""create or edit a note file"""
import argparse
from datetime import date
from os import getenv
from pathlib import Path
import subprocess
import sys
from tempfile import NamedTemporaryFile


def create_note(file, editor):
    """create a note"""
    try:
        Path(file).parent.mkdir(parents=True, exist_ok=True)
        subprocess.run([editor, "--", file], check=True)
    except PermissionError as err:
        raise PermissionError from err
    except subprocess.CalledProcessError as err:
        raise NotImplementedError from err


def select_note(note_dir, prompt):
    """select a note"""
    notes = {}
    selected_note = ""
    cmd = "cat {} | fzf +m --ansi --prompt='{}' --preview='cat {}/{{}}'"
    # grab all files in note directory
    for note in Path(note_dir).glob("*"):
        note = Path(note)
        if not note.is_file():
            continue
        notes[str(note.name)] = str(note.resolve())

    # not using a context manager here as a personal preference, no more indents
    tmpfile = NamedTemporaryFile(mode="w+")
    try:
        with open(tmpfile.name, "w+") as tmp:
            # add note options to tmpfile for piping
            for note in notes:
                tmp.write(note + "\n")
            tmp.seek(0)
            selected_note = subprocess.check_output(
                cmd.format(tmpfile.name, prompt, note_dir),
                shell=True,
            ).decode(sys.stdout.encoding).strip()
    except subprocess.CalledProcessError as err:
        # exit peacefully if the user doesn't select a note
        if not selected_note:
            sys.exit(0)
        raise err
    finally:
        tmpfile.close()

    return notes[selected_note]


def print_error(msg):
    """print an error message"""
    print(msg, file=sys.stderr)


def main():
    """main"""
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "-d", "--delete", action="store_true", help="Delete an existing note"
    )
    parser.add_argument(
        "-e", "--edit", action="store_true", help="Edit an existing note"
    )
    parser.add_argument(
        "-f",
        "--filetype",
        default="md",
        help="Set the filetype of the new note (default: markdown)",
    )
    parser.add_argument(
        "--editor",
        default=getenv("EDITOR"),
        help="Chose the editor to use. (default: $EDITOR)",
    )
    parser.add_argument(
        "--note_dir",
        default=f"{getenv('HOME')}/documents/notes",
        help="Directory to store the note in",
    )
    parser.add_argument(
        "note",
        nargs="?",
        default=str(date.today),
        help="The name of the note (default: today's date)",
    )

    args = parser.parse_args()
    if args.delete:
        try:
            note = select_note(args.note_dir, "delete > ")
            Path(note).unlink()
            print(f"Deleted '{note}'")
            return
        except PermissionError as err:
            raise PermissionError from err
    elif args.edit:
        note = select_note(args.note_dir, "edit > ")
    else:
        note = f"{args.note_dir}/{args.note}.{args.filetype}"

    create_note(note, args.editor)


if __name__ == "__main__":
    main()
